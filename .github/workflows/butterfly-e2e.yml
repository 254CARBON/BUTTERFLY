name: Butterfly E2E Harness

on:
  workflow_dispatch:
    inputs:
      full_stack:
        description: "Also run the optional full-stack compose smoke (Kafka + ODYSSEY stub)"
        required: false
        default: false
        type: boolean
      chaos_scenarios:
        description: "Run chaos/resilience scenarios"
        required: false
        default: false
        type: boolean
      golden_path_full_loop:
        description: "Run full loop golden path (PLATO→SYNAPSE→PERCEPTION→CAPSULE→NEXUS)"
        required: false
        default: false
        type: boolean
  pull_request:
    paths:
      - ".github/workflows/butterfly-e2e.yml"
      - "butterfly-common/**"
      - "butterfly-e2e/**"
      - "scripts/**"
      - "ODYSSEY/**"
      - "PLATO/**"
      - "SYNAPSE/**"
      - "butterfly-nexus/**"
      - "CAPSULE/**"
      - "PERCEPTION/**"
      - "DX_NOTES.md"
      - "DEVELOPMENT_OVERVIEW.md"
  schedule:
    - cron: "0 5 * * *"  # nightly UTC
    - cron: "0 3 * * 0"  # weekly chaos: Sunday 3 AM UTC

env:
  JAVA_VERSION: "17"
  MAVEN_OPTS: "-Xmx1024m"

jobs:
  scenario-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Cache Avro codegen
        uses: actions/cache@v4
        with:
          path: butterfly-common/target/generated-sources/avro
          key: ${{ runner.os }}-avro-${{ hashFiles('butterfly-common/src/main/avro/**') }}

      - name: Build fastpath CLI (warm Maven cache)
        run: |
          chmod +x scripts/fastpath-cli.sh
          ./scripts/fastpath-cli.sh --help

      - name: Run scenario harness (golden + negative)
        env:
          RUN_REFLEX_ASSERTIONS: "1"
          START_DEV_STACK: "1"
          FASTPATH_SKIP_STUB: "1"
        run: |
          chmod +x butterfly-e2e/run-scenarios.sh scripts/dev-up.sh scripts/dev-down.sh
          ./butterfly-e2e/run-scenarios.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-scenario-results
          path: |
            butterfly-e2e/e2e-results/
            butterfly-e2e/chaos-results/
          retention-days: 14

      - name: Generate E2E Summary
        if: always()
        run: |
          echo "## Butterfly E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.head_ref || github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scenarios Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Golden path integration" >> $GITHUB_STEP_SUMMARY
          echo "- Negative scenarios (Kafka hiccup)" >> $GITHUB_STEP_SUMMARY
          echo "- ODYSSEY reflex assertions" >> $GITHUB_STEP_SUMMARY

  # Required for PRs touching core services - ensures full ecosystem integration
  golden-path-full-loop:
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.golden_path_full_loop == 'true') ||
      (github.event_name == 'pull_request' && (
        contains(github.event.pull_request.changed_files, 'PLATO/') ||
        contains(github.event.pull_request.changed_files, 'SYNAPSE/') ||
        contains(github.event.pull_request.changed_files, 'butterfly-nexus/') ||
        contains(github.event.pull_request.changed_files, 'CAPSULE/') ||
        contains(github.event.pull_request.changed_files, 'PERCEPTION/') ||
        contains(github.event.pull_request.changed_files, 'ODYSSEY/')
      ))
    needs: scenario-suite
    runs-on: ubuntu-latest
    services:
      kafka:
        image: bitnami/kafka:3.6
        ports:
          - 9092:9092
        env:
          KAFKA_CFG_NODE_ID: 0
          KAFKA_CFG_PROCESS_ROLES: controller,broker
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@localhost:9093
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build all services
        run: |
          mvn -B -q install -DskipTests -pl butterfly-common,PLATO,SYNAPSE,butterfly-nexus

      - name: Start services with Docker Compose
        run: |
          docker compose -f butterfly-e2e/docker-compose.full.yml up -d
          sleep 30  # Allow services to initialize

      - name: Run full loop golden path
        env:
          PLATO_URL: http://localhost:8084
          SYNAPSE_URL: http://localhost:8086
          NEXUS_URL: http://localhost:8085
          PERCEPTION_URL: http://localhost:8081
          CAPSULE_URL: http://localhost:8082
        run: |
          chmod +x butterfly-e2e/run-golden-path.sh
          ./butterfly-e2e/run-golden-path.sh --strategic --skip-build

      - name: Collect service logs
        if: always()
        run: |
          mkdir -p logs
          docker compose -f butterfly-e2e/docker-compose.full.yml logs --no-color > logs/all-services.log 2>&1 || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-path-full-loop-logs
          path: logs/
          retention-days: 7

      - name: Teardown
        if: always()
        run: docker compose -f butterfly-e2e/docker-compose.full.yml down -v

  chaos-scenarios:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.chaos_scenarios == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Start services
        run: |
          docker compose -f butterfly-e2e/docker-compose.full.yml up -d
          sleep 30

      - name: Run chaos scenarios
        env:
          CHAOS_TIMEOUT: 120
          RESULTS_DIR: ${{ github.workspace }}/chaos-results
        run: |
          chmod +x butterfly-e2e/run-chaos-scenarios.sh
          ./butterfly-e2e/run-chaos-scenarios.sh

      - name: Upload chaos results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-scenario-results
          path: chaos-results/
          retention-days: 14

      - name: Generate Chaos Summary
        if: always()
        run: |
          echo "## Chaos Scenario Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scenarios Tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scenario | Target | Fault Type |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| SYNAPSE Unavailable | PLATO | service_unavailable |" >> $GITHUB_STEP_SUMMARY
          echo "| ODYSSEY Degraded | NEXUS | latency_injection |" >> $GITHUB_STEP_SUMMARY
          echo "| Cassandra Partial Outage | All | data_store_partial_outage |" >> $GITHUB_STEP_SUMMARY

      - name: Teardown
        if: always()
        run: docker compose -f butterfly-e2e/docker-compose.full.yml down -v

  full-stack-smoke:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.full_stack == 'true'
    needs: scenario-suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Start optional full stack (Kafka + ODYSSEY profile)
        env:
          FASTPATH_FULL_STACK: "1"
          FASTPATH_SKIP_STUB: "1"
        run: |
          chmod +x scripts/dev-up.sh scripts/dev-down.sh scripts/fastpath-cli.sh
          ./scripts/dev-up.sh --profile odyssey
          sleep 25  # allow ODYSSEY to finish booting
          ./scripts/fastpath-cli.sh publish --scenario golden-path --topic rim.fast-path --bootstrap localhost:9092 --scenarios-root butterfly-e2e/scenarios
          ./scripts/dev-down.sh

  # Weekly chaos testing - runs every Sunday at 3 AM UTC
  weekly-chaos-suite:
    if: github.event.schedule == '0 3 * * 0'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build all modules
        run: mvn -B -q install -DskipTests

      - name: Start full stack for chaos testing
        run: |
          docker compose -f butterfly-e2e/docker-compose.full.yml up -d
          sleep 60  # Allow services to fully initialize

      - name: Run comprehensive chaos suite
        env:
          CHAOS_TIMEOUT: 300
          RESULTS_DIR: ${{ github.workspace }}/weekly-chaos-results
          RUN_ALL_EXPERIMENTS: "true"
        run: |
          chmod +x butterfly-e2e/run-chaos-scenarios.sh
          mkdir -p $RESULTS_DIR
          
          # Run E2E chaos scenarios
          ./butterfly-e2e/run-chaos-scenarios.sh || true
          
          # Run Chaos Mesh experiments (if available)
          if [ -f chaos/scripts/run-chaos-suite.sh ]; then
            chmod +x chaos/scripts/run-chaos-suite.sh
            ./chaos/scripts/run-chaos-suite.sh --category cross-service --report json --output $RESULTS_DIR/chaos-mesh-results.json || true
          fi

      - name: Collect all service logs
        if: always()
        run: |
          mkdir -p weekly-chaos-results/logs
          docker compose -f butterfly-e2e/docker-compose.full.yml logs --no-color > weekly-chaos-results/logs/all-services.log 2>&1 || true
          
          # Extract service-specific logs
          for svc in plato synapse nexus capsule perception odyssey; do
            docker compose -f butterfly-e2e/docker-compose.full.yml logs $svc --no-color > weekly-chaos-results/logs/${svc}.log 2>&1 || true
          done

      - name: Upload weekly chaos results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-chaos-results-${{ github.run_number }}
          path: weekly-chaos-results/
          retention-days: 90

      - name: Generate Chaos Summary
        if: always()
        run: |
          echo "## Weekly Chaos Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Run Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Date | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Chaos Experiments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Experiment | Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PLATO-SYNAPSE Degraded | SYNAPSE latency | ⏳ |" >> $GITHUB_STEP_SUMMARY
          echo "| NEXUS-PERCEPTION Timeout | PERCEPTION network | ⏳ |" >> $GITHUB_STEP_SUMMARY
          echo "| CAPSULE-ODYSSEY Partition | Network partition | ⏳ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remediation Runbooks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [SYNAPSE Unavailable](docs/operations/runbooks/chaos-synapse-unavailable.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [NEXUS Circuit Open](docs/operations/runbooks/chaos-nexus-circuit-open.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Database Partial Outage](docs/operations/runbooks/chaos-database-partial-outage.md)" >> $GITHUB_STEP_SUMMARY

      - name: Teardown
        if: always()
        run: docker compose -f butterfly-e2e/docker-compose.full.yml down -v

  nightly-full-e2e:
    if: github.event.schedule == '0 5 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build all modules
        run: mvn -B -q install -DskipTests

      - name: Start full stack with Prometheus
        run: |
          docker compose -f butterfly-e2e/docker-compose.full.yml up -d
          sleep 60  # Allow services and metrics collection to initialize

      - name: Run full E2E suite
        env:
          RUN_GOLDEN_PATH: "true"
          RUN_CHAOS: "true"
          RUN_INTEGRATION: "true"
          SKIP_INFRASTRUCTURE: "true"
          RESULTS_DIR: ${{ github.workspace }}/nightly-results
        run: |
          chmod +x butterfly-e2e/run-full-e2e-suite.sh
          ./butterfly-e2e/run-full-e2e-suite.sh

      - name: Run Phase 1 validation scenarios
        env:
          TENANT_ID: e2e-ci
          PROMETHEUS_URL: http://localhost:9090
          PERCEPTION_URL: http://localhost:18081
          CAPSULE_URL: http://localhost:18082
          ODYSSEY_URL: http://localhost:8081
          NEXUS_URL: http://localhost:8080
          PLATO_URL: http://localhost:18084
          SYNAPSE_URL: http://localhost:18086
          RESULTS_DIR: ${{ github.workspace }}/nightly-results/phase1
        run: |
          chmod +x butterfly-e2e/run-phase1-validation.sh
          mkdir -p $RESULTS_DIR
          ./butterfly-e2e/run-phase1-validation.sh --skip-stack || true

      - name: Run Golden Loop SLO validation
        env:
          PROMETHEUS_URL: http://localhost:9090
          RESULTS_DIR: ${{ github.workspace }}/nightly-results/slo
          JUNIT_REPORT: ${{ github.workspace }}/nightly-results/slo/golden-loop-slo-report.xml
        run: |
          chmod +x butterfly-e2e/validate-golden-loop-slo.sh
          mkdir -p $RESULTS_DIR
          ./butterfly-e2e/validate-golden-loop-slo.sh || true

      - name: Push metrics to Prometheus Pushgateway
        if: always()
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL }}
        run: |
          if [ -n "$PUSHGATEWAY_URL" ]; then
            echo "Pushing nightly metrics to Pushgateway..."
            cat <<EOF | curl --data-binary @- "$PUSHGATEWAY_URL/metrics/job/butterfly_e2e_nightly/instance/github_actions"
          # HELP butterfly_e2e_nightly_run_timestamp Unix timestamp of nightly run
          # TYPE butterfly_e2e_nightly_run_timestamp gauge
          butterfly_e2e_nightly_run_timestamp $(date +%s)
          # HELP butterfly_e2e_nightly_run_id GitHub Actions run ID
          # TYPE butterfly_e2e_nightly_run_id gauge
          butterfly_e2e_nightly_run_id ${{ github.run_id }}
          # HELP butterfly_e2e_nightly_status Nightly run status (1=success, 0=failure)
          # TYPE butterfly_e2e_nightly_status gauge
          butterfly_e2e_nightly_status 1
          EOF
          else
            echo "PUSHGATEWAY_URL not configured, skipping metrics push"
          fi

      - name: Run governance decision loop helper
        env:
          TENANT_ID: e2e-ci
          PERCEPTION_URL: http://localhost:18081
          CAPSULE_URL: http://localhost:18082
          ODYSSEY_URL: http://localhost:8081
          NEXUS_URL: http://localhost:8080
          PLATO_URL: http://localhost:18084
          SYNAPSE_URL: http://localhost:18086
        run: |
          chmod +x scripts/run-governance-loop.sh
          ./scripts/run-governance-loop.sh --skip-stack --allow-partial

      - name: Upload nightly results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-e2e-results
          path: nightly-results/
          retention-days: 30

      - name: Upload SLO compliance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-slo-reports-${{ github.run_number }}
          path: |
            nightly-results/slo/
            nightly-results/phase1/
          retention-days: 90

      - name: Publish JUnit Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: |
            nightly-results/junit-report.xml
            nightly-results/slo/golden-loop-slo-report.xml
          check_name: "Nightly E2E Test Report"

      - name: Generate Phase 1 SLO Summary
        if: always()
        run: |
          echo "## Phase 1 SLO Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Run Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Date | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SLO Targets (Phase 1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Target |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Temporal Slice P50 | < 50ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Temporal Slice P95 | < 100ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Temporal Slice P99 | < 200ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Golden Loop P95 | < 2s |" >> $GITHUB_STEP_SUMMARY
          echo "| Golden Loop P99 | < 5s |" >> $GITHUB_STEP_SUMMARY
          echo "| Cross-System Coherence | > 0.7 |" >> $GITHUB_STEP_SUMMARY
          echo "| Loop Success Rate | > 99% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f nightly-results/slo/slo-summary.txt ]; then
            cat nightly-results/slo/slo-summary.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "SLO validation results not available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dashboard Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [NEXUS Temporal SLO Dashboard](https://grafana.butterfly.internal/d/nexus-temporal-slo)" >> $GITHUB_STEP_SUMMARY
          echo "- [Prometheus Alerts](https://prometheus.butterfly.internal/alerts)" >> $GITHUB_STEP_SUMMARY

      - name: Teardown
        if: always()
        run: docker compose -f butterfly-e2e/docker-compose.full.yml down -v

  slo-auditor:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Cache Avro codegen
        uses: actions/cache@v4
        with:
          path: butterfly-common/target/generated-sources/avro
          key: ${{ runner.os }}-avro-${{ hashFiles('butterfly-common/src/main/avro/**') }}

      - name: Prepare scripts
        run: |
          chmod +x butterfly-e2e/run-scenarios.sh butterfly-e2e/check-slo-compliance.sh scripts/dev-up.sh scripts/dev-down.sh

      - name: Run cross-ecosystem SLO gate
        env:
          PROMETHEUS_URL: ${{ secrets.OBS_PROMETHEUS_URL }}
          SCENARIO_COMMAND: "RUN_REFLEX_ASSERTIONS=1 START_DEV_STACK=1 FASTPATH_SKIP_STUB=1 ./butterfly-e2e/run-scenarios.sh --golden-path-only"
        run: |
          if [ -z "${PROMETHEUS_URL}" ]; then
            echo "PROMETHEUS_URL secret not set; skipping SLO audit."
            exit 0
          fi
          ./butterfly-e2e/check-slo-compliance.sh --prometheus-url "${PROMETHEUS_URL}"
