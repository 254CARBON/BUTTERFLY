name: Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev|stage|prod)"
        required: false
        default: "stage"
      tag:
        description: "Container tag override"
        required: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/capsule-service

jobs:
  verify:
    name: Build and verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven
      - name: Build and unit tests
        run: mvn -B clean verify
      - name: Checkstyle
        run: mvn -B checkstyle:checkstyle
      - name: SpotBugs
        run: mvn -B spotbugs:spotbugs

  build_and_scan:
    name: Build, scan and push image
    runs-on: ubuntu-latest
    needs: verify
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=ref,event=tag
            type=sha
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build image
        run: |
          docker build \
            --file Dockerfile \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} \
            .
      - name: Trivy scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          vuln-type: os,library
          exit-code: "1"
      - name: Grype scan
        uses: anchore/scan-action@v3
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          fail-build: true
      - name: Push image
        run: docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}

  deploy:
    name: Deploy via Helm
    runs-on: ubuntu-latest
    needs: build_and_scan
    env:
      DEPLOY_ENV: ${{ github.event.inputs.environment || (github.ref_type == 'tag' && 'prod') || 'stage' }}
      IMAGE_TAG: ${{ needs.build_and_scan.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
      - name: Install Helm
        uses: azure/setup-helm@v4
      - name: Write kubeconfig (dev)
        if: env.DEPLOY_ENV == 'dev'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DEV }}" > ~/.kube/config
      - name: Write kubeconfig (stage)
        if: env.DEPLOY_ENV == 'stage'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_STAGE }}" > ~/.kube/config
      - name: Write kubeconfig (prod)
        if: env.DEPLOY_ENV == 'prod'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" > ~/.kube/config
      - name: Canary rollout
        if: env.DEPLOY_ENV != 'dev'
        run: |
          helm upgrade --install capsule-canary k8s/helm/capsule \
            --namespace capsule --create-namespace \
            -f k8s/helm/capsule/values-${{ env.DEPLOY_ENV }}.yaml \
            --set fullnameOverride=capsule-canary \
            --set replicaCount=1 \
            --set hpa.enabled=false \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --wait --timeout 10m
          kubectl -n capsule rollout status deploy/capsule-canary --timeout=5m
      - name: Promote release
        run: |
          helm upgrade --install capsule k8s/helm/capsule \
            --namespace capsule --create-namespace \
            -f k8s/helm/capsule/values-${{ env.DEPLOY_ENV }}.yaml \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set deploymentStrategy.rollingUpdate.maxUnavailable=0 \
            --set deploymentStrategy.rollingUpdate.maxSurge=1 \
            --wait --timeout 15m
      - name: Cleanup canary
        if: env.DEPLOY_ENV != 'dev'
        run: |
          kubectl -n capsule delete deployment/capsule-canary --ignore-not-found=true
      - name: Verify rollout
        run: kubectl -n capsule rollout status deploy/capsule --timeout=10m
