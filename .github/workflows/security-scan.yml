name: BUTTERFLY Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly security scans on Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      scan_all:
        description: 'Run all security scans'
        required: false
        default: 'true'

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # Dependency vulnerability scanning with OWASP Dependency-Check
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Cache OWASP NVD Database
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: owasp-nvd-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            owasp-nvd-${{ runner.os }}-

      - name: Run OWASP Dependency Check
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressionFile=.github/owasp-suppressions.xml \
            -DnvdApiKey=${{ secrets.NVD_API_KEY }} \
            --batch-mode
        continue-on-error: true

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: '**/target/dependency-check-report.html'
          retention-days: 14

      - name: Check for Critical Vulnerabilities
        run: |
          # Fail if any CVE with CVSS >= 7.0 is found (non-suppressed)
          if grep -r "cvssV3" **/target/dependency-check-report.json 2>/dev/null | grep -E '"baseScore"\s*:\s*[7-9]\.[0-9]|10\.0'; then
            echo "::error::Critical vulnerabilities (CVSS >= 7.0) found!"
            exit 1
          fi
        continue-on-error: ${{ github.event_name == 'schedule' }}

  # Static Application Security Testing with CodeQL
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: +security-extended,security-and-quality

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Build with Maven (for CodeQL)
        run: mvn compile -DskipTests --batch-mode

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

  # Static analysis with Semgrep
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config auto \
            --config p/java \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --json \
            --output semgrep-results.json \
            --error \
            --severity ERROR
        continue-on-error: true

      - name: Upload Semgrep Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 14

      - name: Convert to SARIF
        run: |
          semgrep scan \
            --config auto \
            --config p/java \
            --config p/security-audit \
            --sarif \
            --output semgrep.sarif \
            || true

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

  # Secret scanning with TruffleHog
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

      - name: Fail on Secrets
        run: |
          # Check if any verified secrets were found
          if [ -f trufflehog-results.json ] && [ -s trufflehog-results.json ]; then
            echo "::error::Verified secrets found in the codebase!"
            exit 1
          fi
        continue-on-error: true

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Check Licenses
        run: |
          mvn license:third-party-report \
            -Dlicense.excludedScopes=test \
            --batch-mode || true

      - name: Upload License Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report
          path: '**/target/site/third-party-report.html'
          retention-days: 14

  # Container image scanning (if Dockerfiles exist)
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: ${{ hashFiles('**/Dockerfile') != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Find Dockerfiles
        id: dockerfiles
        run: |
          echo "files=$(find . -name 'Dockerfile' -type f | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Build Images for Scanning
        run: |
          for dockerfile in ${{ steps.dockerfiles.outputs.files }}; do
            dir=$(dirname $dockerfile)
            name=$(echo $dir | tr '/' '-' | sed 's/^-//')
            docker build -t butterfly-$name:scan -f $dockerfile $dir || true
          done

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'butterfly:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true

  # Security compliance summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, codeql, semgrep, trufflehog, license-check]
    if: always()
    steps:
      - name: Check Overall Status
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP Dependency Check | ${{ needs.dependency-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep SAST | ${{ needs.semgrep.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog Secrets | ${{ needs.trufflehog.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-check.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ðŸ” Security Scan Results

            | Check | Status |
            |-------|--------|
            | OWASP Dependency Check | ${{ needs.dependency-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | CodeQL Analysis | ${{ needs.codeql.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | Semgrep SAST | ${{ needs.semgrep.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | TruffleHog Secrets | ${{ needs.trufflehog.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | License Compliance | ${{ needs.license-check.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |

            > View detailed reports in the workflow artifacts.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Fail if Critical Issues
        if: |
          needs.dependency-check.result == 'failure' ||
          needs.codeql.result == 'failure' ||
          needs.trufflehog.result == 'failure'
        run: |
          echo "::error::Critical security issues detected. Please review the scan reports."
          exit 1
