# =============================================================================
# HorizontalPodAutoscalers for BUTTERFLY HA Deployment
# =============================================================================
# These HPAs automatically scale services based on CPU, memory, and custom metrics.
# Custom metrics require Prometheus Adapter configured in the cluster.
# =============================================================================

---
# CAPSULE HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: capsule-hpa
  namespace: butterfly
  labels:
    app: capsule
    app.kubernetes.io/part-of: butterfly-platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: capsule
  minReplicas: 3
  maxReplicas: 12
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    # Custom metric: Cassandra query latency
    - type: Pods
      pods:
        metric:
          name: capsule_query_latency_p95
        target:
          type: AverageValue
          averageValue: "50m"  # 50ms
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 60
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
      selectPolicy: Min

---
# PERCEPTION HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: perception-hpa
  namespace: butterfly
  labels:
    app: perception-api
    app.kubernetes.io/part-of: butterfly-platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: perception-api
  minReplicas: 3
  maxReplicas: 15
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    # Custom metric: Kafka consumer lag
    - type: External
      external:
        metric:
          name: kafka_consumer_group_lag
          selector:
            matchLabels:
              consumer_group: perception-signals
        target:
          type: Value
          value: "500"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
    scaleDown:
      stabilizationWindowSeconds: 300

---
# ODYSSEY HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: odyssey-hpa
  namespace: butterfly
  labels:
    app: odyssey
    app.kubernetes.io/part-of: butterfly-platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: odyssey
  minReplicas: 3
  maxReplicas: 15
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300

---
# PLATO HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: plato-hpa
  namespace: butterfly
  labels:
    app: plato
    app.kubernetes.io/part-of: butterfly-platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: plato
  minReplicas: 3
  maxReplicas: 12
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    # Custom metric: Plan execution queue depth
    - type: Pods
      pods:
        metric:
          name: plato_plan_queue_size
        target:
          type: AverageValue
          averageValue: "50"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300

---
# NEXUS HPA (Critical Gateway)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nexus-hpa
  namespace: butterfly
  labels:
    app: nexus
    app.kubernetes.io/part-of: butterfly-platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nexus
  minReplicas: 5
  maxReplicas: 25
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75
    # Custom metric: Temporal slice P95 latency
    - type: Pods
      pods:
        metric:
          name: nexus_temporal_slice_query_duration_p95
        target:
          type: AverageValue
          averageValue: "100m"  # 100ms
    # Custom metric: Concurrent queries
    - type: Pods
      pods:
        metric:
          name: nexus_queries_active
        target:
          type: AverageValue
          averageValue: "100"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Percent
          value: 50
          periodSeconds: 30
        - type: Pods
          value: 3
          periodSeconds: 30
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
      selectPolicy: Min

---
# SYNAPSE HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: synapse-hpa
  namespace: butterfly
  labels:
    app: synapse
    app.kubernetes.io/part-of: butterfly-platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: synapse
  minReplicas: 3
  maxReplicas: 15
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    # Custom metric: Action queue depth
    - type: Pods
      pods:
        metric:
          name: synapse_action_queue_size
        target:
          type: AverageValue
          averageValue: "100"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
    scaleDown:
      stabilizationWindowSeconds: 300

