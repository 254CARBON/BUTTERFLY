# Chaos Mesh Helm Values for BUTTERFLY Platform
# 
# Installation:
#   helm install chaos-mesh chaos-mesh/chaos-mesh \
#     --namespace chaos-mesh \
#     --create-namespace \
#     -f chaos-mesh-values.yaml
#
# Documentation: https://chaos-mesh.org/docs/

# Controller Manager Configuration
controllerManager:
  # High availability setup
  replicaCount: 3
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Pod affinity for HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: controller-manager
            topologyKey: kubernetes.io/hostname

# Chaos Daemon Configuration (runs on each node)
chaosDaemon:
  runtime: containerd
  socketPath: /run/containerd/containerd.sock
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Tolerate all taints to run on all nodes
  tolerations:
    - operator: Exists

# Dashboard Configuration
dashboard:
  enabled: true
  
  replicaCount: 2
  
  # Enable ingress for dashboard access
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - name: chaos.butterfly.local
        paths:
          - /
    tls:
      - secretName: chaos-dashboard-tls
        hosts:
          - chaos.butterfly.local
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
  
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# DNS Server for DNS chaos experiments
dnsServer:
  enabled: true
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

# Prometheus metrics
prometheus:
  enabled: true
  
  serviceMonitor:
    enabled: true
    namespace: monitoring
    labels:
      release: prometheus

# RBAC Configuration
rbac:
  create: true

# Security settings
security:
  # Enable authentication for dashboard
  auth:
    enabled: true
  
  # TLS for internal communication
  tls:
    enabled: false  # Enable in production

# Namespace configuration
# Limit chaos injection to specific namespaces for safety
controllerManager:
  env:
    NAMESPACE_SCOPED: "false"
    TEMPLATE_NAMESPACE: "butterfly"
    TARGET_NAMESPACE: "butterfly"
  
  # Only allow chaos in butterfly namespace by default
  allowedNamespaces:
    - butterfly
    - butterfly-staging
    - butterfly-canary

# Webhook configuration
webhook:
  # Fail open to prevent blocking deployments
  failurePolicy: Ignore
  
  timeoutSeconds: 10

# Logging
logging:
  level: info
  format: json

# Feature flags
features:
  # Enable all chaos types
  enablePodChaos: true
  enableNetworkChaos: true
  enableIOChaos: true
  enableTimeChaos: true
  enableStressChaos: true
  enableKernelChaos: false  # Requires privileged mode
  enableDNSChaos: true
  enableHTTPChaos: true
  enableJVMChaos: true
  enableAWSChaos: false
  enableGCPChaos: false
  enableAzureChaos: false

# Image configuration
images:
  registry: ghcr.io
  tag: v2.6.3

# Pod security standards
podSecurityPolicy:
  enabled: false  # Deprecated in K8s 1.25+

